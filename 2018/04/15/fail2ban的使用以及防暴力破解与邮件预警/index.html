<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>fail2ban的使用以及防暴力破解与邮件预警 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="通过开源的防护软件来防护安全 使用背景：最近公网网站一直被别人暴力破解sshd服务密码。虽然没有成功，但会导致系统负载很高，原因是在暴力破解的时候，系统会不断地认证用户，从而增加了系统资源额外开销，导致访问公司网站速度很慢。 fail2ban可以监视你的系统日志，然后匹配日志的错误信息（正则式匹配）执行相应的屏蔽动作（一般情况下是防火墙），而且可以发送e-mail通知系统管理员，很好、很实用、">
<meta property="og:type" content="article">
<meta property="og:title" content="fail2ban的使用以及防暴力破解与邮件预警">
<meta property="og:url" content="http://example.com/2018/04/15/fail2ban%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%98%B2%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E4%B8%8E%E9%82%AE%E4%BB%B6%E9%A2%84%E8%AD%A6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="通过开源的防护软件来防护安全 使用背景：最近公网网站一直被别人暴力破解sshd服务密码。虽然没有成功，但会导致系统负载很高，原因是在暴力破解的时候，系统会不断地认证用户，从而增加了系统资源额外开销，导致访问公司网站速度很慢。 fail2ban可以监视你的系统日志，然后匹配日志的错误信息（正则式匹配）执行相应的屏蔽动作（一般情况下是防火墙），而且可以发送e-mail通知系统管理员，很好、很实用、">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-04-15T03:27:07.000Z">
<meta property="article:modified_time" content="2018-12-16T10:24:02.021Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-fail2ban的使用以及防暴力破解与邮件预警" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/15/fail2ban%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%98%B2%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E4%B8%8E%E9%82%AE%E4%BB%B6%E9%A2%84%E8%AD%A6/" class="article-date">
  <time datetime="2018-04-15T03:27:07.000Z" itemprop="datePublished">2018-04-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      fail2ban的使用以及防暴力破解与邮件预警
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p> 通过开源的防护软件来防护安全</p>
<h1 id="使用背景："><a href="#使用背景：" class="headerlink" title="使用背景："></a>使用背景：</h1><p>最近公网网站一直被别人暴力破解sshd服务密码。虽然没有成功，但会导致系统负载很高，原因是在暴力破解的时候，系统会不断地认证用户，从而增加了系统资源额外开销，导致访问公司网站速度很慢。</p>
<p>fail2ban可以监视你的系统日志，然后匹配日志的错误信息（正则式匹配）执行相应的屏蔽动作（一般情况下是防火墙），而且可以发送e-mail通知系统管理员，很好、很实用、很强大！</p>
<hr>
<p>ban （bæn）禁令<br>简单来说其功能就是防止暴力破解。工作的原理是通过分析一定时间内的相关服务日志，将满足动作的相关IP利用iptables加入到dorp列表一定时间。<br>所以 使用fail2ban先安装iptables  </p>
<hr>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>Centos7.X 开始,系统自带的防火墙是firewalld,但是也同样支持iptables<br>–关闭firewall：   </p>
<pre><code>[root@ssh1 ~]# systemctl stop firewalld.service          #停止firewall  
[root@ssh1 ~]# systemctl disable firewalld.service       #禁止firewall开机启动  </code></pre>
<p>–安装安装iptables防火墙  </p>
<pre><code>[root@ssh1 ~]# yum install iptables-services              #安装</code></pre>
<p>注：重启iptables服务的话，所有DORP将重置。<br>配置文件位置：  </p>
<pre><code> [root@ssh1 ~]# ls /etc/sysconfig/iptables
 /etc/sysconfig/iptables</code></pre>
<p>启动服务  </p>
<pre><code>[root@ssh1 ~]# systemctl start iptables.service
[root@ssh1 ~]# systemctl enable iptables.service</code></pre>
<hr>
<h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><p>1.下载软件包：  </p>
<pre><code>http://www.fail2ban.org     http://www.fail2ban.org/wiki/index.php/Downloads  </code></pre>
<p>2.解压查看readme文件</p>
<pre><code>[root@ssh1 ~]# tar xf fail2ban-0.9.4.tar.gz
[root@ssh1 fail2ban-0.9.4]# vim README.md  #查看以下内容</code></pre>
<p>3.安装：</p>
<pre><code>[root@redis fail2ban-0.9.4]# python setup.py install</code></pre>
<p>4.管理文件结构介绍</p>
<p>1）/etc/fail2ban/action.d<br>动作文件夹，内含默认文件。iptables以及mail等动作配置<br>2）/etc/fail2ban/fail2ban.conf<br>定义fail2ban日志级别，日志位置及sock文件位置<br>3）/etc/fail2ban/filter.d<br>条件文件夹，内含默认文件。过滤日志关键内容设置<br>4）/etc/fail2ban/jail.conf<br>主配置文件、模块化。主要设置启用ban动作的服务以及动作阀值。<br>5）/etc/rc.d/init.d/fail2ban<br>fail2ban服务的启动脚本  </p>
<p>5.生成服务启动脚本：  </p>
<pre><code>[root@ssh1 ~]# cp fail2ban-0.9.4/files/redhat-initd /etc/rc.d/init.d/fail2ban
[root@ssh1 ~]# chkconfig --add fail2ban     //开机自启</code></pre>
<p>6.fail2ban配置</p>
<p>/etc/fail2ban/fail2ban.conf  </p>
<pre><code>[Definition]  
loglevel = INFO  
logtarget = SYSLOG  
syslogsocket = auto  
socket = /var/run/fail2ban/fail2ban.sock  
pidfile = /var/run/fail2ban/fail2ban.pid  
dbfile = /var/lib/fail2ban/fail2ban.sqlite3  
dbpurgeage = 86400  
注：以上不做任何修改</code></pre>
<hr>
<p>/etc/fail2ban/jail.conf</p>
<p>邮件发送 ： 注意的是：iptables和sendmail必须对齐，要不然会发生错误；</p>
<pre><code> [sshd]                   #单个服务检查设置，如设置bantime、findtime、maxretry和全局冲突，服务优先级大于全局设置。
 enabled  = true             #是否激活此项（true/false）
 filter   = sshd              #过滤规则filter的名字，对应filter.d目录下的sshd.conf
 action   = iptables[name=SSH, port=ssh, protocol=tcp]#动作的相关参数，对应action.d/iptables.conf文件
 logpath  = /var/log/secure         #检测的日志文件path
 bantime  = 3600
 findtime  = 300
 maxretry = 3</code></pre>
<hr>
<p>防攻击规则参见：</p>
<pre><code> # (1)SSH防攻击规则
[ssh-iptables]
enabled  = true
filter   = sshd
action   = iptables[name=SSH, port=ssh, protocol=tcp]
           sendmail-whois[name=SSH, dest=root, sender=fail2ban@example.com, sendername=&quot;Fail2Ban&quot;]
logpath  = /var/log/secure
maxretry = 5

[ssh-ddos]
enabled = true
filter  = sshd-ddos
action  = iptables[name=ssh-ddos, port=ssh,sftp protocol=tcp,udp]
logpath  = /var/log/messages
maxretry = 2

[osx-ssh-ipfw]
enabled  = true
filter   = sshd
action   = osx-ipfw
logpath  = /var/log/secure.log
maxretry = 5

[ssh-apf]
enabled = true
filter  = sshd
action  = apf[name=SSH]
logpath = /var/log/secure
maxretry = 5

[osx-ssh-afctl]
enabled  = true
filter   = sshd
action   = osx-afctl[bantime=600]
logpath  = /var/log/secure.log
maxretry = 5

[selinux-ssh]
enabled = true
filter  = selinux-ssh
action  = iptables[name=SELINUX-SSH, port=ssh, protocol=tcp]
logpath  = /var/log/audit/audit.log
maxretry = 5

(2)proftp防攻击规则
[proftpd-iptables]
enabled  = true
filter   = proftpd
action   = iptables[name=ProFTPD, port=ftp, protocol=tcp]
           sendmail-whois[name=ProFTPD, dest=you@example.com]
logpath  = /var/log/proftpd/proftpd.log
maxretry = 6

(3)邮件防攻击规则
[sasl-iptables]
enabled  = true
filter   = postfix-sasl
backend  = polling
action   = iptables[name=sasl, port=smtp, protocol=tcp]
           sendmail-whois[name=sasl, dest=you@example.com]
logpath  = /var/log/mail.log
[dovecot]
enabled = true
filter  = dovecot
action  = iptables-multiport[name=dovecot, port=&quot;pop3,pop3s,imap,imaps,submission,smtps,sieve&quot;, protocol=tcp]
logpath = /var/log/mail.log
[dovecot-auth]
enabled = true
filter  = dovecot
action  = iptables-multiport[name=dovecot-auth, port=&quot;pop3,pop3s,imap,imaps,submission,smtps,sieve&quot;, protocol=tcp]
logpath = /var/log/secure
[perdition]
enabled = true
filter  = perdition
vaction  = iptables-multiport[name=perdition,port=&quot;110,143,993,995&quot;]
logpath = /var/log/maillog

[uwimap-auth]
enabled = true
filter  = uwimap-auth
action  = iptables-multiport[name=uwimap-auth,port=&quot;110,143,993,995&quot;]
logpath = /var/log/maillog

(4)apache防攻击规则
[apache-tcpwrapper]
enabled  = true
filter  = apache-auth
action   = hostsdeny
logpath  = /var/log/httpd/error_log
maxretry = 6
[apache-badbots]
enabled  = true
filter   = apache-badbots
action   = iptables-multiport[name=BadBots, port=&quot;http,https&quot;]
           sendmail-buffered[name=BadBots, lines=5, dest=you@example.com]
logpath  = /var/log/httpd/access_log
bantime  = 172800
maxretry = 1
[apache-shorewall]
enabled  = true
filter   = apache-noscript
action   = shorewall
       sendmail[name=Postfix, dest=you@example.com]
logpath  = /var/log/httpd/error_log

(5)nginx防攻击规则
[nginx-http-auth]
enabled = true
filter  = nginx-http-auth
action  = iptables-multiport[name=nginx-http-auth,port=&quot;80,443&quot;]
logpath = /var/log/nginx/error.log

(6)lighttpd防规击规则
[suhosin]
enabled  = true
filter   = suhosin
action   = iptables-multiport[name=suhosin, port=&quot;http,https&quot;]
# adapt the following two items as needed
logpath  = /var/log/lighttpd/error.log
maxretry = 2
[lighttpd-auth]
enabled  = true
filter   = lighttpd-auth
action   = iptables-multiport[name=lighttpd-auth, port=&quot;http,https&quot;]
# adapt the following two items as needed
logpath  = /var/log/lighttpd/error.log
maxretry = 2

(7)vsftpd防攻击规则
[vsftpd-notification]
enabled  = true
filter   = vsftpd
action   = sendmail-whois[name=VSFTPD, dest=you@example.com]
logpath  = /var/log/vsftpd.log
maxretry = 5
bantime  = 1800
[vsftpd-iptables]
enabled  = true
filter   = vsftpd
action   = iptables[name=VSFTPD, port=ftp, protocol=tcp]
           sendmail-whois[name=VSFTPD, dest=you@example.com]
logpath  = /var/log/vsftpd.log
maxretry = 5
bantime  = 1800
(8)pure-ftpd防攻击规则
[pure-ftpd]
enabled  = true
filter   = pure-ftpd
action   = iptables[name=pure-ftpd, port=ftp, protocol=tcp]
logpath  = /var/log/pureftpd.log
maxretry = 2
bantime  = 86400

(9)mysql防攻击规则
[mysqld-iptables]
enabled  = true
filter   = mysqld-auth
action   = iptables[name=mysql, port=3306, protocol=tcp]
           sendmail-whois[name=MySQL, dest=root, sender=fail2ban@example.com]
logpath  = /var/log/mysqld.log
maxretry = 5

(10)apache phpmyadmin防攻击规则
[apache-phpmyadmin]
enabled  = true
filter   = apache-phpmyadmin
action  = iptables[name=phpmyadmin, port=http,https protocol=tcp]
logpath  = /var/log/httpd/error_log
maxretry = 3


# /etc/fail2ban/filter.d/apache-phpmyadmin.conf    
将以下内容粘贴到apache-phpmyadmin.conf里保存即可以创建一个apache-phpmyadmin.conf文件.
# Fail2Ban configuration file
#
# Bans bots scanning for non-existing phpMyAdmin installations on your webhost.
#
# Author: Gina Haeussge
#
[Definition]
docroot = /var/www
badadmin = PMA|phpmyadmin|myadmin|mysql|mysqladmin|sqladmin|mypma|admin|xampp|mysqldb|mydb|db|pmadb|phpmyadmin1|phpmyadmin2
# Option:  failregex
# Notes.:  Regexp to match often probed and not available phpmyadmin paths.
# Values:  TEXT
#
failregex = [[]client []] File does not exist: %(docroot)s/(?:%(badadmin)s)
# Option:  ignoreregex
# Notes.:  regex to ignore. If this regex matches, the line is ignored.
# Values:  TEXT
#
ignoreregex =</code></pre>
<hr>
<p>7.服务启动</p>
<pre><code>[root@ssh1 ~]# systemctl restart fail2ban</code></pre>
<p>注：fail2ban一定后于iptables启动，即重启iptables一定要重启fail2ban，相反重启fail2ban不用重新启iptables。</p>
<p>8.查询限制列表  红色表示由fail2ban限制</p>
<pre><code>[root@ssh1 ~]#  iptables -L --line-numbers</code></pre>
<p>9.解除fail2ban绑定的IP  </p>
<pre><code>[root@ssh1 ~]#  iptables -D f2b-ssh 1</code></pre>
<p>解除第一个拒绝的IP</p>
<p>10 . 统计登陆失败的IP  </p>
<pre><code>[root@ssh1 ~]# find /var/log -name &#39;secure*&#39; -type f | while read line;do awk &#39;/Failed/&#123;print $(NF-3)&#125;&#39; $line;done | awk &#39;&#123;a[$0]++&#125;END&#123;for (j in a) if(a[j] &gt; 20) print j&quot;=&quot;a[j]&#125;&#39; | sort -n -t&#39;=&#39; -k 2
    10.10.11.19=67
    202.99.172.155=24
   222.178.229.67=1005</code></pre>
<p>fail2ban状态监控脚本<br>因为重启iptables需要重启fai2ban服务，故而我们需要增加此监控脚本防止管理员疏忽。<br>1）增加脚本文件夹  </p>
<pre><code>mkdir ~/script</code></pre>
<p>2）vim编辑~/script/f2bAutoRestart.sh加入如下内容  </p>
<pre><code> #!/bin/bash
 fl=$(iptables -L -v -n | grep &#39;Chain f&#39; | wc -l)#echo $flif [ $fl -eq 0 ]; then
 echo &#39;restart fai2band&#39;
 /etc/init.d/fail2ban restart
fi</code></pre>
<p>3)添加计划任务  </p>
<pre><code> crontab -e</code></pre>
<p>添加如下内容： </p>
<pre><code> */5 * * * * sh ~/script/f2bAutoRestart.sh</code></pre>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/04/15/fail2ban%E7%9A%84%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E9%98%B2%E6%9A%B4%E5%8A%9B%E7%A0%B4%E8%A7%A3%E4%B8%8E%E9%82%AE%E4%BB%B6%E9%A2%84%E8%AD%A6/" data-id="ckibpb0eo00118cj0ci052dxe" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/05/02/Linux%E4%BC%98%E5%8C%96%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Linux优化思维导图
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LVS/">LVS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Zabbix/">Zabbix</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/12/02/test/">test</a>
          </li>
        
          <li>
            <a href="/2019/01/03/CloudBoot/">CloudBoot</a>
          </li>
        
          <li>
            <a href="/2019/01/01/LVS%E9%9B%86%E7%BE%A4-NAT%E6%A8%A1%E5%BC%8F/">LVS集群-NAT模式</a>
          </li>
        
          <li>
            <a href="/2018/12/13/Docker%E7%A7%81%E6%9C%89registry%20Harbor/">Docker私有registry Harbor</a>
          </li>
        
          <li>
            <a href="/2018/12/12/Docker%E9%95%9C%E5%83%8F%E7%AE%A1%E7%90%86/">Docker镜像管理</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>